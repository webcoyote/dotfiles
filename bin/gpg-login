#!/usr/bin/env bash
set -Eeuo pipefail

# Key already cached in memory?
RESULT=$(gpg-connect-agent 'keyinfo --list' /bye 2>/dev/null | \
    awk 'BEGIN{CACHED=0} /^S/ {if($7==1){CACHED=1}} END{if(NR>0){print CACHED} else {print "none"}}')
if [[ "$RESULT" == "1" ]]; then
    echo >&2 "gpg-login cached"
    exit 0
fi

pkill gpg-agent || true
if ! echo "test" | gpg --clearsign &> /dev/null ; then
    echo >&2 "gpg-login failed"
    exit 1
fi


echo >&2 "gpg-login successful"
exit 0
